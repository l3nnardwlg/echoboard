<!doctype html><html lang="de"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>{{ room.title }} • Gruppenchat</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
:root{--bg:#060c1a;--surface:#101a33;--line:rgba(148,163,184,0.2);--text:#f8fafc;--text-soft:#94a3b8;--accent:#38bdf8;}
body{margin:0;min-height:100vh;padding:28px;background:radial-gradient(circle at top,var(--surface)0%,var(--bg)55%,#030712 100%);
font-family:"Segoe UI",system-ui,-apple-system,sans-serif;color:var(--text);display:flex;justify-content:center;}
.wrap{width:100%;max-width:960px;background:rgba(15,23,42,0.78);border:1px solid var(--line);border-radius:28px;padding:32px;
box-shadow:0 30px 70px rgba(8,15,30,0.55);display:flex;flex-direction:column;gap:22px;}
.header{display:flex;justify-content:space-between;align-items:center;gap:14px;}
.header h1{margin:0;font-size:1.8rem;letter-spacing:-.01em;}
.header small{color:var(--text-soft);}
.log{flex:1;max-height:520px;overflow:auto;display:flex;flex-direction:column;gap:12px;padding-right:6px;}
.message{display:flex;flex-direction:column;gap:6px;max-width:75%;background:rgba(15,23,42,0.6);border:1px solid var(--line);
border-radius:18px;padding:12px 16px;}
.message.me{margin-left:auto;background:linear-gradient(135deg,var(--accent),#0ea5e9);border:none;color:#fff;}
.message strong{font-size:0.85rem;}
.message span{font-size:0.78rem;color:var(--text-soft);}
.composer{display:flex;gap:12px;align-items:center;}
.composer textarea{flex:1;border-radius:18px;background:rgba(15,23,42,0.7);border:1px solid var(--line);color:var(--text);
padding:12px 16px;min-height:80px;}
.composer button{border-radius:18px;padding:12px 20px;background:linear-gradient(135deg,var(--accent),#0ea5e9);border:none;color:#fff;
font-weight:600;cursor:pointer;box-shadow:0 18px 40px rgba(56,189,248,0.35);} 
.meta{font-size:0.85rem;color:var(--text-soft);display:flex;justify-content:space-between;align-items:center;}
.typing{min-height:20px;color:var(--text-soft);font-style:italic;}
@media(max-width:720px){body{padding:18px}.wrap{padding:24px;border-radius:22px}.composer{flex-direction:column;align-items:stretch}}
</style></head><body>
<div class="wrap">
  <header class="header">
    <div>
      <h1>{{ room.title }}</h1>
      <small>Gemeinschaftsraum · {{ room.slug }}</small>
    </div>
    <div style="font-size:0.9rem;color:var(--text-soft);">Willkommen, {{ me.username }}</div>
  </header>
  <div id="log" class="log">
    {% for m in messages %}
    <div class="message {% if m.sender_id==me.id %}me{% endif %}">
      <strong>{{ m.sender_name or 'System' }}</strong>
      <div>{{ m.text }}</div>
      <span>{{ m.created_at }}</span>
    </div>
    {% endfor %}
  </div>
  <div class="meta">
    <div class="typing" id="typing"></div>
    <button type="button" id="history-refresh">↻ Verlauf aktualisieren</button>
  </div>
  <div class="composer">
    <textarea id="text" placeholder="Nachricht an alle…"></textarea>
    <button type="button" id="send">Senden</button>
  </div>
</div>
<script>
  const slug = "{{ room.slug }}";
  const me = {{ me.id }};
  const socket = io("/", { transports:["polling","websocket"], upgrade:true, path:"/socket.io/" });
  const log = document.getElementById('log');
  const text = document.getElementById('text');
  const typing = document.getElementById('typing');
  const sendBtn = document.getElementById('send');
  const refreshBtn = document.getElementById('history-refresh');

  function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;",""":"&quot;","'":"&#039;"}[s])); }

  function renderMessage(msg){
    const div = document.createElement('div');
    div.className = 'message' + (msg.sender_id === me ? ' me' : '');
    div.innerHTML = `<strong>${escapeHtml(msg.sender_name || 'System')}</strong><div>${escapeHtml(msg.text || '')}</div><span>${msg.created_at}</span>`;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
  }

  socket.on('connect', () => {
    socket.emit('group_join', { slug });
  });

  socket.on('group_history', (messages) => {
    log.innerHTML = '';
    messages.forEach(renderMessage);
  });

  socket.on('group_new', (message) => {
    renderMessage(message);
  });

  socket.on('group_typing', (authors) => {
    const list = (authors || []).filter(name => name);
    typing.textContent = list.length ? `${list.join(', ')} tippt…` : '';
  });

  sendBtn.addEventListener('click', () => send());
  text.addEventListener('keydown', (event) => {
    if(event.key === 'Enter' && !event.shiftKey){
      event.preventDefault();
      send();
    } else {
      socket.emit('group_typing', { slug });
      clearTimeout(send.typingTimeout);
      send.typingTimeout = setTimeout(() => socket.emit('group_stop_typing', { slug }), 1000);
    }
  });

  refreshBtn.addEventListener('click', () => socket.emit('group_join', { slug }));

  function send(){
    const value = text.value.trim();
    if(!value) return;
    socket.emit('group_send', { slug, text: value });
    text.value = '';
    socket.emit('group_stop_typing', { slug });
  }

  window.addEventListener('beforeunload', () => socket.emit('group_stop_typing', { slug }));
</script>
</body></html>
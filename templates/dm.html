<!doctype html><html lang="de"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Chat mit {{ other.username }} • EchoBoard</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
:root{--bg:#060c1a;--surface:#101a33;--line:rgba(148,163,184,0.18);--text:#f8fafc;--text-soft:#94a3b8;--accent:#38bdf8;--accent-strong:#0ea5e9;--success:#22c55e;}
body{margin:0;min-height:100vh;padding:28px;background:radial-gradient(circle at top,var(--surface)0%,var(--bg)55%,#030712 100%);
font-family:"Segoe UI",system-ui,-apple-system,sans-serif;color:var(--text);display:flex;justify-content:center;}
.wrap{width:100%;max-width:900px;background:rgba(15,23,42,0.78);border:1px solid var(--line);border-radius:28px;padding:30px;
box-shadow:0 28px 70px rgba(8,15,30,0.55);display:flex;flex-direction:column;gap:20px;}
.header{display:flex;justify-content:space-between;align-items:center;gap:14px;}
.header-info{display:flex;align-items:center;gap:16px;}
.avatar{width:64px;height:64px;border-radius:24px;background:rgba(56,189,248,0.16);display:flex;align-items:center;justify-content:center;font-size:1.6rem;font-weight:600;}
.state{font-size:0.9rem;color:var(--text-soft);}
.log{flex:1;max-height:520px;overflow:auto;display:flex;flex-direction:column;gap:12px;padding-right:6px;}
.message{display:flex;flex-direction:column;gap:6px;max-width:75%;background:rgba(15,23,42,0.6);border:1px solid var(--line);border-radius:18px;padding:12px 16px;position:relative;}
.message.me{margin-left:auto;background:linear-gradient(135deg,var(--accent),var(--accent-strong));border:none;color:#fff;}
.message-header{display:flex;justify-content:space-between;align-items:center;font-size:0.82rem;}
.message-body{white-space:pre-wrap;line-height:1.5;font-size:1rem;}
.message-footer{display:flex;justify-content:space-between;align-items:center;font-size:0.78rem;color:var(--text-soft);gap:12px;}
.actions{display:flex;gap:6px;flex-wrap:wrap;}
.actions button{border-radius:12px;border:1px solid rgba(148,163,184,0.25);background:rgba(15,23,42,0.55);color:var(--text);padding:4px 8px;font-size:0.75rem;cursor:pointer;}
.reactions{display:flex;gap:6px;margin-top:4px;flex-wrap:wrap;font-size:0.85rem;}
audio{width:100%;margin-top:8px;}
.composer{display:grid;grid-template-columns:minmax(0,1fr) auto auto;gap:12px;align-items:center;}
.composer textarea{flex:1;border-radius:18px;border:1px solid var(--line);background:rgba(15,23,42,0.6);color:var(--text);padding:12px 16px;min-height:90px;}
.composer input[type="file"]{padding:8px;border-radius:14px;border:1px solid var(--line);background:rgba(15,23,42,0.5);color:var(--text-soft);}
.composer button{border-radius:18px;background:linear-gradient(135deg,var(--accent),var(--accent-strong));border:none;color:#fff;padding:12px 18px;font-weight:600;cursor:pointer;box-shadow:0 18px 40px rgba(56,189,248,0.35);}
.meta{display:flex;justify-content:space-between;align-items:center;color:var(--text-soft);font-size:0.85rem;}
.typing{min-height:20px;font-style:italic;}
@media(max-width:720px){body{padding:18px}.wrap{padding:22px;border-radius:22px}.message{max-width:85%;}.composer{grid-template-columns:1fr;}}
</style></head><body>
<div class="wrap">
  <header class="header">
    <div class="header-info">
      {% if other.avatar %}<img src="/u/avatars/{{ other.avatar }}" alt="Avatar" class="avatar">{% else %}<div class="avatar">{{ other.username[:2].upper() }}</div>{% endif %}
      <div>
        <h1 style="margin:0;">{{ other.username }}</h1>
        <div class="state" id="state">• offline</div>
      </div>
    </div>
    <div style="color:var(--text-soft);font-size:0.9rem;">Direktnachrichten</div>
  </header>
  <div id="log" class="log">
    {% for m in messages %}
    <div class="message {% if m.sender_id==me.id %}me{% endif %}" data-id="{{ m.id }}">
      <div class="message-header"><strong>{{ 'Ich' if m.sender_id==me.id else other.username }}</strong><span>{{ m.created_at }}</span></div>
      <div class="message-body">{{ m.text }}</div>
      {% if m.voice_url %}<audio controls src="{{ m.voice_url }}"></audio>{% endif %}
      <div class="reactions">
        {% for r in m.reactions %}
        <span>{{ r.emoji }} {{ r.count }}</span>
        {% endfor %}
      </div>
      <div class="message-footer">
        <div class="actions">
          <button type="button" data-action="react" data-id="{{ m.id }}">Reagieren</button>
          {% if m.sender_id==me.id %}<button type="button" data-action="edit" data-id="{{ m.id }}">Bearbeiten</button><button type="button" data-action="delete" data-id="{{ m.id }}">Löschen</button>{% endif %}
        </div>
        {% if m.sender_id==me.id %}
        <span>{% if m.read_at %}✔ gelesen{% else %}✓ gesendet{% endif %}</span>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  <div class="meta">
    <div class="typing" id="typing"></div>
    <div id="voiceStatus"></div>
  </div>
  <div class="composer">
    <textarea id="text" placeholder="Nachricht eingeben…"></textarea>
    <input type="file" id="voice" accept="audio/*">
    <button type="button" id="send">Senden</button>
  </div>
</div>
<script>
  const slug = "{{ other.username }}";
  const meId = {{ me.id }};
  const log = document.getElementById('log');
  const input = document.getElementById('text');
  const sendBtn = document.getElementById('send');
  const voiceInput = document.getElementById('voice');
  const stateLabel = document.getElementById('state');
  const typingEl = document.getElementById('typing');
  const voiceStatus = document.getElementById('voiceStatus');
  const socket = io("/", { transports:["polling","websocket"], upgrade:true, path:"/socket.io/" });
  let voiceAttachment = null;

  const ESCAPE_MAP = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  function escapeHtml(text){ return (text || "").replace(/[&<>"']/g, (s) => ESCAPE_MAP[s] || s); }

  function render(message){
    const existing = log.querySelector(`[data-id="${message.id}"]`);
    const div = existing || document.createElement('div');
    div.className = 'message' + (message.sender_id === meId ? ' me' : '');
    div.dataset.id = message.id;
    div.innerHTML = `
      <div class="message-header"><strong>${escapeHtml(message.sender_id === meId ? 'Ich' : slug)}</strong><span>${escapeHtml(message.created_at || '')}</span></div>
      <div class="message-body">${escapeHtml(message.text || '')}</div>
      ${message.voice_url ? `<audio controls src="${message.voice_url}"></audio>` : ''}
      <div class="reactions">${(message.reactions || []).map(r => `<span>${escapeHtml(r.emoji)} ${r.count}</span>`).join('')}</div>
      <div class="message-footer">
        <div class="actions">
          <button type="button" data-action="react" data-id="${message.id}">Reagieren</button>
          ${message.sender_id === meId ? `<button type="button" data-action="edit" data-id="${message.id}">Bearbeiten</button><button type="button" data-action="delete" data-id="${message.id}">Löschen</button>` : ''}
        </div>
        ${message.sender_id === meId ? `<span>${message.read_at ? '✔ gelesen' : '✓ gesendet'}</span>` : ''}
      </div>`;
    if(!existing){
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }
    div.querySelectorAll('[data-action]').forEach(btn => btn.onclick = () => handleAction(btn.dataset.id, btn.dataset.action));
  }

  function handleAction(id, action){
    if(action === 'react'){
      const emoji = prompt('Emoji eingeben (z. B. 😀)');
      if(emoji){ socket.emit('dm_react', { messageId:Number(id), emoji }); }
    }
    if(action === 'edit'){
      const current = log.querySelector(`[data-id="${id}"] .message-body`)?.textContent || '';
      const text = prompt('Nachricht bearbeiten', current);
      if(text){ socket.emit('dm_edit', { messageId:Number(id), text }); }
    }
    if(action === 'delete'){
      if(confirm('Nachricht wirklich löschen?')){ socket.emit('dm_delete', { messageId:Number(id) }); }
    }
  }

  socket.on('connect', () => { socket.emit('dm_join', { other: slug }); });
  socket.on('dm_presence', ({other_online}) => { stateLabel.textContent = other_online ? '• online' : '• offline'; });
  socket.on('dm_new', (m) => {
    render(m);
    if(m.sender_id !== meId){ socket.emit('dm_read', { messageId: m.id }); }
  });
  socket.on('dm_reactions', ({messageId, reactions}) => {
    const message = { id: messageId, reactions };
    const existing = log.querySelector(`[data-id="${messageId}"]`);
    if(existing){
      const body = existing.querySelector('.message-body').textContent;
      render({ id: messageId, sender_id: existing.classList.contains('me') ? meId : null, text: body, created_at: existing.querySelector('.message-header span').textContent, reactions, voice_url: existing.querySelector('audio')?.getAttribute('src'), read_at: existing.querySelector('.message-footer span')?.textContent?.includes('gelesen') });
    }
  });
  socket.on('dm_updated', (msg) => { render(msg); });
  socket.on('dm_deleted', ({id}) => {
    const el = log.querySelector(`[data-id="${id}"]`);
    if(el){ el.parentElement.removeChild(el); }
  });
  socket.on('dm_typing', ({authors}) => { const list = (authors || []).filter(Boolean); typingEl.textContent = list.length ? `${list.join(', ')} tippt…` : ''; });
  socket.on('dm_read', ({id}) => {
    const el = log.querySelector(`[data-id="${id}"] .message-footer span`);
    if(el){ el.textContent = '✔ gelesen'; }
  });

  if(sendBtn){ sendBtn.addEventListener('click', () => send()); }
  input.addEventListener('keydown', (event) => {
    if(event.key === 'Enter' && !event.shiftKey){ event.preventDefault(); send(); }
    else { socket.emit('dm_typing', { to: slug }); clearTimeout(send.typingTimeout); send.typingTimeout = setTimeout(() => socket.emit('dm_stop_typing', { to: slug }), 1000); }
  });

  voiceInput.addEventListener('change', async (event) => {
    const file = event.target.files[0];
    if(!file) return;
    voiceStatus.textContent = 'Audio wird hochgeladen…';
    const form = new FormData(); form.append('file', file);
    try {
      const res = await fetch('/api/dm/upload', { method:'POST', body: form });
      if(!res.ok) throw new Error('Upload fehlgeschlagen');
      voiceAttachment = await res.json();
      voiceStatus.textContent = '🎙️ ' + (voiceAttachment.name || 'Audio bereit');
    } catch(err){ voiceStatus.textContent = 'Audio-Upload fehlgeschlagen'; voiceAttachment = null; }
  });

  function send(){
    const value = input.value.trim();
    if(!value && !voiceAttachment) return;
    socket.emit('dm_send', { to: slug, text: value, voice: voiceAttachment ? voiceAttachment.stored : null });
    input.value='';
    voiceInput.value='';
    voiceStatus.textContent='';
    voiceAttachment=null;
    socket.emit('dm_stop_typing', { to: slug });
  }

  window.addEventListener('beforeunload', () => socket.emit('dm_stop_typing', { to: slug }));
</script>
</body></html>
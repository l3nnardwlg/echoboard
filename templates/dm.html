<!doctype html><html lang="de"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Chat mit {{ other.username }} • EchoBoard</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
:root{--bg:#0b1220;--bg-soft:#111c34;--surface:#101a33;--accent:#3b82f6;--accent-strong:#1d4ed8;--text:#f8fafc;--text-soft:#94a3b8;--success:#22c55e;}
*{box-sizing:border-box}
body{margin:0;min-height:100vh;padding:32px;font-family:"Segoe UI",system-ui,-apple-system,sans-serif;color:var(--text);background:radial-gradient(circle at top,var(--bg-soft)0%,var(--bg)55%,#060b16 100%);display:flex;justify-content:center}
.wrap{width:100%;max-width:960px;background:var(--surface);border:1px solid rgba(148,163,184,.2);border-radius:32px;padding:32px;box-shadow:0 30px 60px rgba(8,15,30,.4);display:flex;flex-direction:column;gap:24px;position:relative;overflow:hidden}
.wrap::after{content:"";position:absolute;inset:0;background:radial-gradient(circle at 85% 10%,rgba(59,130,246,.12),transparent 55%);pointer-events:none}
.header{display:flex;justify-content:space-between;align-items:center;gap:18px;position:relative;z-index:1}
.header-info{display:flex;align-items:center;gap:16px}
.avatar{width:64px;height:64px;border-radius:24px;background:rgba(59,130,246,.15);display:flex;align-items:center;justify-content:center;font-size:1.6rem;font-weight:600;color:var(--accent);object-fit:cover}
.header h1{margin:0;font-size:1.8rem;letter-spacing:-.01em}
.state{font-size:.95rem;color:var(--text-soft)}
.log{flex:1;min-height:420px;max-height:520px;overflow:auto;display:flex;flex-direction:column;gap:14px;padding-right:8px;position:relative;z-index:1}
.message{display:flex;flex-direction:column;gap:6px;max-width:70%}
.message .author{font-size:.8rem;font-weight:600;color:var(--accent)}
.bubble{padding:14px 18px;border-radius:20px 20px 20px 8px;background:rgba(15,23,42,.8);border:1px solid rgba(148,163,184,.2);line-height:1.5;font-size:1rem;color:var(--text)}
.message.me{margin-left:auto;align-items:flex-end}
.message.me .author{color:var(--success)}
.message.me .bubble{background:linear-gradient(135deg,var(--accent),var(--accent-strong));border:none;color:#f8fafc;border-radius:20px 20px 8px 20px;box-shadow:0 18px 36px rgba(59,130,246,.35)}
.composer{display:flex;gap:16px;align-items:center;position:relative;z-index:1}
.composer input{flex:1;border-radius:22px;border:1px solid rgba(148,163,184,.25);background:rgba(15,23,42,.75);color:var(--text);padding:14px 18px;font-size:1rem}
.composer input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 4px rgba(59,130,246,.18)}
.composer button{border-radius:22px;background:linear-gradient(135deg,var(--accent),var(--accent-strong));border:none;color:#f8fafc;padding:14px 24px;font-weight:600;cursor:pointer;box-shadow:0 16px 32px rgba(59,130,246,.35)}
.composer button:hover{transform:translateY(-1px);box-shadow:0 20px 42px rgba(59,130,246,.45)}
@media(max-width:720px){body{padding:24px}.wrap{padding:24px;border-radius:26px}.header{flex-direction:column;align-items:flex-start}.message{max-width:85%}}
</style></head><body>
<div class="wrap">
  <header class="header">
    <div class="header-info">
      {% if other.avatar %}
        <img src="/u/avatars/{{ other.avatar }}" alt="Avatar" class="avatar">
      {% else %}
        <div class="avatar">{{ other.username[:2].upper() }}</div>
      {% endif %}
      <div>
        <h1>{{ other.username }}</h1>
        <div class="state" id="state">• offline</div>
      </div>
    </div>
    <div style="color:var(--text-soft);font-size:.9rem">Direktnachrichten im EchoBoard Messenger</div>
  </header>
  <div id="log" class="log">
    {% for m in messages %}
      <div class="message {{ 'me' if m.sender_id==me.id else '' }}">
        <span class="author">{{ 'Ich' if m.sender_id==me.id else other.username }}</span>
        <div class="bubble">{{ m.text }}</div>
      </div>
    {% endfor %}
  </div>
  <div class="composer">
    <input id="text" placeholder="Nachricht eingeben…">
    <button type="button" onclick="send()">Senden</button>
  </div>
</div>
<script>
  const other = "{{ other.username }}";
  const meId = {{ me.id }};
  const log = document.getElementById("log");
  const input = document.getElementById("text");
  const state = document.getElementById("state");
  const socket = io("/", { transports:["polling","websocket"], upgrade:true, path:"/socket.io/" });

  function escapeHtml(text){
    return (text || "").replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[s]));
  }

  function add(author, text, isMe){
    const div = document.createElement("div");
    div.className = "message" + (isMe ? " me" : "");
    div.innerHTML = `<span class="author">${escapeHtml(author)}</span><div class="bubble">${escapeHtml(text)}</div>`;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
  }

  socket.on("connect", ()=>{
    socket.emit("dm_join", { other });
  });

  socket.on("dm_presence", ({other_online})=>{
    state.textContent = other_online ? "• online" : "• offline";
  });

  socket.on("dm_new", (m)=>{
    if(m.sender_id === meId) return;
    add(other, m.text, false);
  });

  function send(){
    const t = input.value.trim();
    if(!t) return;
    socket.emit("dm_send", { to: other, text: t });
    add("Ich", t, true);
    input.value = "";
  }

  input.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){ e.preventDefault(); send(); }
  });

  log.scrollTop = log.scrollHeight;
</script>
</body></html>
